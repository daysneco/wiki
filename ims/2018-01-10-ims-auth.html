<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/normalize.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
        <title>IMS鉴权 - Norris</title>
        <meta name="keywords" content="technology"/>
        <meta name="description" content="A wiki website of Norris"/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width" />
        
        <script type="text/javascript" 
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>

        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)']]}
            });
        </script>

        <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-78529611-1', 'auto');
          ga('send', 'pageview');

        </script>
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/wiki/">Home</a>&nbsp;»&nbsp;<a href="/wiki/#ims">ims</a>&nbsp;»&nbsp;IMS鉴权</div>
</div>
<div class="clearfix"></div>
<div id="title">IMS鉴权</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#ims">IMS注册流程</a></li>
<li><a href="#_1">终端鉴权算法</a></li>
<li><a href="#aka">AKA</a><ul>
<li><a href="#usim">USIM参数和应用</a></li>
<li><a href="#_2">符号含义</a></li>
<li><a href="#_3">举例</a></li>
</ul>
</li>
<li><a href="#_4">参考</a></li>
</ul>
</div>
<p>IMS鉴权主要有：</p>
<ul>
<li><strong>SIP Digest</strong>(SIP摘要)：针对无ISIM卡的终端</li>
<li><strong>HTTP Digest</strong>(HTTP摘要)：SIP协议的基本认证方式，用于UAS/SIP Proxy Server对UAC的单向认证</li>
<li><strong>IMS AKA</strong>(AKAv1_MD5、AKAv2_MD5(：对HTTP摘要认证的扩展，用于UE和IM CN网络之间的双向认证，同时协商得到UE和IM CN共享的完整性密钥IK(Integrity Key)和加密密钥CK(Ciphering Key)，在UE和IM CN协商建立的IPSec SAs连接上提供完整性保护(Integrity Protection)和机密性保护(Confidentiality Protection)</li>
</ul>
<h2 id="ims">IMS注册流程</h2>
<p><img alt="" src="/wiki/static/images/2018-01-11-IMS-Register.png" /></p>
<h2 id="_1">终端鉴权算法</h2>
<p>目前终端都是使用的AKAv1_MD5算法，可以从UE的注册日志中确认。</p>
<div class="hlcode"><pre><span class="mh">2017</span> <span class="n">Jul</span> <span class="mh">12</span>  <span class="mh">08</span><span class="o">:</span><span class="mh">56</span><span class="o">:</span><span class="mf">24.546</span>  <span class="p">[</span><span class="no">B0</span><span class="p">]</span>  <span class="mh">0</span><span class="n">x156E</span>  <span class="no">IMS</span> <span class="no">SIP</span> <span class="n">Message</span>  <span class="o">--</span>  <span class="no">IMS_SIP_REGISTER</span><span class="o">/</span><span class="no">UNAUTHORIZED</span>
<span class="p">...</span>
<span class="no">WWW</span><span class="o">-</span><span class="nl">Authenticate:</span> <span class="n">Digest</span> <span class="n">realm</span><span class="o">=</span><span class="s">&quot;ims.mnc000.mcc460.3gppnetwork.org&quot;</span><span class="p">,</span><span class="n">nonce</span><span class="o">=</span><span class="s">&quot;lAusUHute2JpIL+4+eBGVXfrphO9IQABazyikcth0XQ=&quot;</span><span class="p">,</span><span class="n">algorithm</span><span class="o">=</span><span class="n">AKAv1</span><span class="o">-</span><span class="no">MD5</span>
</pre></div>


<h2 id="aka">AKA</h2>
<p>AKA：<strong>A</strong>uthentication and <strong>K</strong>ey <strong>A</strong>greement（身份验证和密钥协议），该机制是由IETF制定，并且被3GPP广泛采用于GSM/UMTS/LTE/IMS等技术中。详细可以参考 <a href="https://tools.ietf.org/html/rfc3310">RFC 3310</a>。</p>
<h3 id="usim">USIM参数和应用</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>长度</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>K</td>
<td>128bit</td>
<td>密钥</td>
</tr>
<tr>
<td>RAND</td>
<td>128bit</td>
<td>随机值</td>
</tr>
<tr>
<td>SQN</td>
<td>48bit</td>
<td>序列号</td>
</tr>
<tr>
<td>AMF</td>
<td>16bit</td>
<td>鉴权管理域</td>
</tr>
<tr>
<td>MAC</td>
<td>64bit</td>
<td>消息鉴权码：f1k(SQN||RAND||AMF)</td>
</tr>
<tr>
<td>MAC-A</td>
<td>64bit</td>
<td>网络鉴权码，一般鉴权时为MAC</td>
</tr>
<tr>
<td>MAC-S</td>
<td>64bit</td>
<td>重同步鉴权码，=MAC</td>
</tr>
<tr>
<td>(X)RES</td>
<td>64bit</td>
<td>鉴权响应：f2k(RAND)</td>
</tr>
<tr>
<td>CK</td>
<td>128bit</td>
<td>加密密钥：f3k(RAND)</td>
</tr>
<tr>
<td>IK</td>
<td>128bit</td>
<td>完整性密钥：f4k(RAND)</td>
</tr>
<tr>
<td>AK</td>
<td>48bit</td>
<td>匿名钥匙：f5k(RAND)</td>
</tr>
<tr>
<td>AUTN</td>
<td>128bit</td>
<td>SQN ⊕ AK || AMF || MAC</td>
</tr>
<tr>
<td>XDOUT</td>
<td>128bit</td>
<td>K ⊕ RAND</td>
</tr>
<tr>
<td>CDOUT</td>
<td>128bit</td>
<td>SQN || AMF</td>
</tr>
</tbody>
</table>
<h3 id="_2">符号含义</h3>
<table>
<thead>
<tr>
<th>符号</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>等于</td>
</tr>
<tr>
<td>||</td>
<td>连接运算，如0000 || 0001 = 00000001</td>
</tr>
<tr>
<td>⊕</td>
<td>异或运算，如0000 ⊕ 0011 = 0011</td>
</tr>
</tbody>
</table>
<h3 id="_3">举例</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>K</td>
<td>000102030405060708090a0b0c0d0e0f<br />00000000 00000001 00000010 00000011 00000100 00000101 00000110 00000111 00001000 00001001 00001010 00001011 00001100 00001101 00001110 00001111</td>
</tr>
<tr>
<td>RAND</td>
<td>6d06a714fe2def464562a53db0db7d50<br />01101101 00000110 10100111 00010100 11111110 00101101 11101111 01000110 01000101 01100010 10100101 00111101 10110000 11011011 01111101 01010000</td>
</tr>
<tr>
<td>AMF</td>
<td>8000<br />10000000 00000000</td>
</tr>
<tr>
<td>SQN</td>
<td>000000000001<br />00000000 00000000 00000000 00000000 00000000 00000001</td>
</tr>
</tbody>
</table>
<div class="hlcode"><pre><span class="n">XDOUT</span> <span class="o">=</span> <span class="n">K</span> <span class="err">⊕</span> <span class="n">RAND</span> <span class="o">=</span> <span class="mo">01101101000001111010010100010111111110100010100011101001010000010100110101101011101011110011011010111100110101100111001101011111</span>
<span class="o">=</span> <span class="mi">6</span><span class="n">D07A517FA28E9414D6BAF36BCD6735F</span>
<span class="n">XRES</span> <span class="o">=</span> <span class="n">f2</span><span class="p">(</span><span class="n">XDOUT</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">6</span><span class="n">D07A517FA28E9414D6BAF36BCD6735F</span>
<span class="n">CK</span> <span class="o">=</span> <span class="n">f3</span><span class="p">(</span><span class="n">XDOUT</span><span class="p">)</span> <span class="o">=</span> <span class="n">XDOUT</span><span class="err">循环左移</span><span class="mi">8</span><span class="n">bits</span> <span class="o">=</span> 
  <span class="mo">07</span><span class="n">a517fa28e9414d6baf36bcd6735f6d</span>
<span class="n">IK</span> <span class="o">=</span> <span class="n">f4</span><span class="err">（</span><span class="n">XDOUT</span><span class="err">）</span> <span class="o">=</span> <span class="n">XDOUT</span><span class="err">循环左移</span><span class="mi">15</span><span class="n">bits</span> <span class="o">=</span> 
  <span class="n">a517fa28e9414d6baf36bcd6735f6d07</span>
<span class="n">AK</span> <span class="o">=</span> <span class="n">XDUT</span><span class="p">[</span><span class="n">b24</span><span class="p">,</span><span class="mi">25</span><span class="p">,..</span><span class="mf">.70</span><span class="p">,</span><span class="mi">71</span><span class="p">]</span> <span class="o">=</span> 
  <span class="mf">17f</span><span class="n">a28e9414d</span>
<span class="n">CDOUT</span> <span class="o">=</span> <span class="n">SQN</span> <span class="o">||</span> <span class="n">AMF</span> <span class="o">=</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000001</span> <span class="mi">10000000</span> <span class="mo">00000000</span> <span class="o">=</span> <span class="mo">000000000001</span><span class="mi">8000</span>
<span class="n">XMAC</span> <span class="o">=</span> <span class="n">XDOUT</span><span class="p">[</span><span class="n">b0</span><span class="p">,</span><span class="mi">1</span><span class="p">,..</span><span class="mf">.62</span><span class="p">,</span><span class="mi">63</span><span class="p">]</span> <span class="err">⊕</span> <span class="n">CDOUT</span><span class="p">[</span><span class="n">b0</span><span class="p">,</span><span class="mi">1</span><span class="p">,..</span><span class="mf">.62</span><span class="p">,</span><span class="mi">63</span><span class="p">]</span> <span class="o">=</span> 
  <span class="mi">6</span><span class="n">d07a517fa296941</span>
<span class="n">AUTN</span> <span class="o">=</span> <span class="n">SQN</span> <span class="err">⊕</span> <span class="n">AK</span> <span class="o">||</span> <span class="n">AMF</span> <span class="o">||</span> <span class="n">MAC</span> <span class="o">=</span>
  <span class="mf">17f</span><span class="n">a28e9414c80006d07a517fa296941</span>
</pre></div>


<p>从SIP消息中我们读取下面的信息，分别为UAS发送给UAC的，和UAC回复UAS的响应。nonce = (RAND + AUTN + [服务器制定的信息] ) + <a href="http://www1.tc711.com/tool/BASE64.htm">BASE64</a>编码。</p>
<div class="hlcode"><pre><span class="n">WWW</span><span class="o">-</span><span class="n">Authenticate</span><span class="o">:</span> <span class="n">Digest</span>  
    <span class="n">realm</span><span class="o">=</span><span class="s">&quot;ims.mnc000.mcc460.3gppnetwork.org&quot;</span><span class="p">,</span>
    <span class="n">nonce</span><span class="o">=</span><span class="s">&quot;bQanFP4t70ZFYqU9sNt9UBf6KOlBTIAAbQelF/opaUE=&quot;</span><span class="p">,</span>
    <span class="n">opaque</span><span class="o">=</span><span class="s">&quot;1f7e898d3940e21e23d82ffa7bfe9141&quot;</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="o">=</span><span class="n">AKAv1</span><span class="o">-</span><span class="n">MD5</span><span class="p">,</span>
    <span class="n">qop</span><span class="o">=</span><span class="s">&quot;auth&quot;</span>

<span class="nl">Authorization:</span> <span class="n">Digest</span> 
    <span class="n">username</span><span class="o">=</span><span class="s">&quot;460001234567890@ims.mnc000.mcc460.3gppnetwork.org&quot;</span><span class="p">,</span>
    <span class="n">realm</span><span class="o">=</span><span class="s">&quot;ims.mnc000.mcc460.3gppnetwork.org&quot;</span><span class="p">,</span>
    <span class="n">uri</span><span class="o">=</span><span class="s">&quot;sip:ims.mnc000.mcc460.3gppnetwork.org&quot;</span><span class="p">,</span>
    <span class="n">qop</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span>
    <span class="n">nonce</span><span class="o">=</span><span class="s">&quot;bQanFP4t70ZFYqU9sNt9UBf6KOlBTIAAbQelF/opaUE=&quot;</span><span class="p">,</span>
    <span class="n">nc</span><span class="o">=</span><span class="mo">00000001</span><span class="p">,</span>
    <span class="n">cnonce</span><span class="o">=</span><span class="s">&quot;1374676361&quot;</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="o">=</span><span class="n">AKAv1</span><span class="o">-</span><span class="n">MD5</span><span class="p">,</span>
    <span class="n">response</span><span class="o">=</span><span class="s">&quot;8b8cad6c93b68b879594f8b731e3fcf4&quot;</span><span class="p">,</span>
    <span class="n">opaque</span><span class="o">=</span><span class="s">&quot;1f7e898d3940e21e23d82ffa7bfe9141&quot;</span>
</pre></div>


<p>可以看到SIP消息中的nonce的值就是RAND + AUTN。</p>
<p><img alt="" src="/wiki/static/images/2018-01-11-Base64编码_解码器.png" /></p>
<h2 id="_4">参考</h2>
<blockquote>
<p>3GPP TS 35.206</p>
</blockquote>
</div>
<div id="content-footer">created in <span class="create-date date"> 2018-01-10 11:43 </span></div>
<div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script type="text/javascript">
const gitment = new Gitment({
  id: location.pathname,
  title: 'IMS鉴权',
  owner: 'tracholar',
  repo: 'wiki',
  oauth: {
    client_id: '0cc0476e504b5e70ae7c',
    client_secret: 'ab98e39ef79469040057eba9c6b2b543b84c72ee',
  },
  // ...
  // For more available options, check out the documentation below
})

gitment.render('comments')
// or
// gitment.render(document.getElementById('comments'))
// or
// document.body.appendChild(gitment.render())
</script>

        </div>
        <div id="footer">
            <span>
                Copyright © 2018 Norris.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Fork me in <a href="https://github.com/daysneco/wiki" target="_blank"> github </a>.
            </span>
        </div>
        

        <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?df74779713027375e7b79302fb72d7b0";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>


        <script src="/wiki/tipuesearch_content.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch_set.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch.min.js"></script>
    </body>
</html>