<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/normalize.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
        <title>设计模式之观察者模式 - Norris</title>
        <meta name="keywords" content="technology"/>
        <meta name="description" content="A wiki website of Norris"/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width" />
        
        <script type="text/javascript" 
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>

        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)']]}
            });
        </script>

        <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-78529611-1', 'auto');
          ga('send', 'pageview');

        </script>
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/wiki/">Home</a>&nbsp;»&nbsp;<a href="/wiki/#android">android</a>&nbsp;»&nbsp;设计模式之观察者模式</div>
</div>
<div class="clearfix"></div>
<div id="title">设计模式之观察者模式</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">定义</a></li>
<li><a href="#registrantlist">RegistrantList消息处理机制</a><ul>
<li><a href="#_2">注册观察者</a></li>
<li><a href="#_3">发出通知</a></li>
<li><a href="#_4">响应通知</a></li>
<li><a href="#_5">取消注册</a></li>
</ul>
</li>
<li><a href="#registrant">Registrant介绍</a></li>
<li><a href="#registrantlist_1">RegistrantList具体实现</a><ul>
<li><a href="#_6">添加观察者</a></li>
<li><a href="#_7">发送通知</a></li>
<li><a href="#_8">取消注册</a></li>
</ul>
</li>
</ul>
</div>
<h3 id="_1">定义</h3>
<p>观察者模式(Observer Pattern)：对象间的一种一对多依赖关系，使得每当一个对象状态发生改变时，其相关依赖对象皆得到通知并被自动更新。观察者模式又叫做发布-订阅（Publish/Subscribe）模式、模型-视图（Model/View）模式、源-监听器（Source/Listener）模式或从属者（Dependents）模式。</p>
<p>观察者模式是一种对象行为型模式。</p>
<h3 id="registrantlist">RegistrantList消息处理机制</h3>
<p>Android Telephony中大量使用RegistrantList进行消息处理，它是观察者模式的一种实现方式。</p>
<p><img alt="" src="/wiki/static/images/RegistrantList.png" /></p>
<p>其中：</p>
<ul>
<li>RegistrantList是通知者</li>
<li>Registrant是观察者</li>
</ul>
<p>也是一种一对多的依赖关系，每一个通知者可以对应一个或多个观察者，当事件列表有更新时，观察者列表中的所有对象都会收到通知。</p>
<h4 id="_2">注册观察者</h4>
<p>在android中注册观察者的方法一般都是类似于：registerXXX</p>
<div class="hlcode"><pre><span class="nd">@IccRecords.java</span>
<span class="kd">protected</span> <span class="n">RegistrantList</span> <span class="n">mRecordsLoadedRegistrants</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RegistrantList</span><span class="o">();</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerForRecordsLoaded</span><span class="o">(</span><span class="n">Handler</span> <span class="n">h</span><span class="o">,</span> <span class="kt">int</span> <span class="n">what</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mDestroyed</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">Registrant</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Registrant</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">what</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
    <span class="n">mRecordsLoadedRegistrants</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">mRecordsToLoad</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mRecordsRequested</span> <span class="o">==</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">r</span><span class="o">.</span><span class="na">notifyRegistrant</span><span class="o">(</span><span class="k">new</span> <span class="n">AsyncResult</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>这个函数的主要功能是：</p>
<ul>
<li>创建一个Registrant</li>
<li>把Registrant（r）加入到RegistrantList（mRecordsLoadedRegistrants）中</li>
<li>当满足条件时发出通知</li>
</ul>
<p>注册观察者形式比较简单，如下，只是调用上面的方法就可以了。</p>
<div class="hlcode"><pre><span class="nd">@IccCardProxy.java</span>
<span class="n">mIccRecords</span><span class="o">.</span><span class="na">registerForRecordsLoaded</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">EVENT_RECORDS_LOADED</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</pre></div>


<h4 id="_3">发出通知</h4>
<p>在满足一定条件的时候就发出通知，让注册观察者端进行处理相应的逻辑。</p>
<div class="hlcode"><pre><span class="nd">@SIMRecords.java</span>
<span class="n">mRecordsLoadedRegistrants</span><span class="o">.</span><span class="na">notifyRegistrants</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">AsyncResult</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
</pre></div>


<h4 id="_4">响应通知</h4>
<p>当注册观察者端接收到通知之后，就在对应的<code>handleMessage</code>中进行处理。比如在前面注册的是<strong>EVENT_RECORDS_LOADED</strong>，所以在对应的<code>handleMessage</code>中可以看到如下代码。</p>
<div class="hlcode"><pre><span class="nd">@IccCardProxy.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">EVENT_RECORDS_LOADED:</span>
            <span class="c1">// Update the MCC/MNC.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mIccRecords</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Phone</span> <span class="n">currentPhone</span> <span class="o">=</span> <span class="n">PhoneFactory</span><span class="o">.</span><span class="na">getPhone</span><span class="o">(</span><span class="n">mPhoneId</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">currentPhone</span><span class="o">.</span><span class="na">getOperatorNumeric</span><span class="o">();</span>
                <span class="n">log</span><span class="o">(</span><span class="s">&quot;operator=&quot;</span> <span class="o">+</span> <span class="n">operator</span> <span class="o">+</span> <span class="s">&quot; mPhoneId=&quot;</span> <span class="o">+</span> <span class="n">mPhoneId</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(!</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">operator</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">mTelephonyManager</span><span class="o">.</span><span class="na">setSimOperatorNumericForPhone</span><span class="o">(</span><span class="n">mPhoneId</span><span class="o">,</span> <span class="n">operator</span><span class="o">);</span>
                    <span class="n">String</span> <span class="n">countryCode</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">3</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">countryCode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mTelephonyManager</span><span class="o">.</span><span class="na">setSimCountryIsoForPhone</span><span class="o">(</span><span class="n">mPhoneId</span><span class="o">,</span>
                                <span class="n">MccTable</span><span class="o">.</span><span class="na">countryCodeForMcc</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">countryCode</span><span class="o">)));</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">loge</span><span class="o">(</span><span class="s">&quot;EVENT_RECORDS_LOADED Country code is null&quot;</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">loge</span><span class="o">(</span><span class="s">&quot;EVENT_RECORDS_LOADED Operator name is null&quot;</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mUiccCard</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mUiccCard</span><span class="o">.</span><span class="na">areCarrierPriviligeRulesLoaded</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">mUiccCard</span><span class="o">.</span><span class="na">registerForCarrierPrivilegeRulesLoaded</span><span class="o">(</span>
                        <span class="k">this</span><span class="o">,</span> <span class="n">EVENT_CARRIER_PRIVILEGES_LOADED</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">onRecordsLoaded</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">loge</span><span class="o">(</span><span class="s">&quot;Unhandled message with number: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>然后回去对应的Message中去进行相应的处理。</p>
<h4 id="_5">取消注册</h4>
<div class="hlcode"><pre><span class="nd">@IccRecords.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterForRecordsLoaded</span><span class="o">(</span><span class="n">Handler</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mRecordsLoadedRegistrants</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>取消注册也比较简单，只是调用下<code>remove</code>方法就可以了。</p>
<h3 id="registrant">Registrant介绍</h3>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Registrant</span>
<span class="o">{</span>
    <span class="n">WeakReference</span>   <span class="n">refH</span><span class="o">;</span>
    <span class="kt">int</span>             <span class="n">what</span><span class="o">;</span>
    <span class="n">Object</span>          <span class="n">userObj</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>


<p>观察中定义了三个成员对象，用以保存调用者的信息。主要的功能是用于发送通知。</p>
<div class="hlcode"><pre><span class="n">internalNotifyRegistrant</span> <span class="o">(</span><span class="n">Object</span> <span class="n">result</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">exception</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">Handler</span> <span class="n">h</span> <span class="o">=</span> <span class="n">getHandler</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">clear</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">what</span><span class="o">;</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AsyncResult</span><span class="o">(</span><span class="n">userObj</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
        <span class="n">h</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>当<code>Handler</code>不为空的时候，通过<code>sendMessage</code>方法把消息发送给调用者。</li>
</ul>
<h3 id="registrantlist_1">RegistrantList具体实现</h3>
<p>前面我们介绍了下RegistrantList消息处理机制，以android中的一次调用进行举例说明，了解了如何注册、通知、去注册，明白了消息的处理逻辑。这里重点介绍下RegistrantList的具体实现。</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegistrantList</span>
<span class="o">{</span>
    <span class="n">ArrayList</span>   <span class="n">registrants</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>


<p>RegistrantList中就定义了一个<code>ArrayList</code>类型的成员变量用来维护所有的观察者。</p>
<h4 id="_6">添加观察者</h4>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span>
<span class="nf">add</span><span class="o">(</span><span class="n">Registrant</span> <span class="n">r</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">removeCleared</span><span class="o">();</span>
    <span class="n">registrants</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span>
<span class="nf">removeCleared</span><span class="o">()</span>
<span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">registrants</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
        <span class="n">Registrant</span>  <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">Registrant</span><span class="o">)</span> <span class="n">registrants</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">refH</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">registrants</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>清除数组列表中所有<code>Handler</code>为空的对象</li>
<li>把新的观察者加入到数组列表中</li>
</ul>
<h4 id="_7">发送通知</h4>
<div class="hlcode"><pre><span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span>
<span class="nf">internalNotifyRegistrants</span> <span class="o">(</span><span class="n">Object</span> <span class="n">result</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">exception</span><span class="o">)</span>
<span class="o">{</span>
   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">registrants</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">Registrant</span>  <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">Registrant</span><span class="o">)</span> <span class="n">registrants</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">r</span><span class="o">.</span><span class="na">internalNotifyRegistrant</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>遍历整个数组列表，分别调用观察者的方法，把消息发送给调用者。</li>
</ul>
<h4 id="_8">取消注册</h4>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span>
<span class="nf">remove</span><span class="o">(</span><span class="n">Handler</span> <span class="n">h</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">registrants</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">Registrant</span>  <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">Registrant</span><span class="o">)</span> <span class="n">registrants</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">Handler</span>     <span class="n">rh</span><span class="o">;</span>
        <span class="n">rh</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">getHandler</span><span class="o">();</span>
        <span class="cm">/* Clean up both the requested registrant and</span>
<span class="cm">         * any now-collected registrants</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rh</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">rh</span> <span class="o">==</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">r</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">removeCleared</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>遍历整个数组列表，把所有的观察者从列表中删除。</li>
</ul>
</div>
<div id="content-footer">created in <span class="create-date date"> 2018-01-02 21:22 </span></div>
<div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script type="text/javascript">
const gitment = new Gitment({
  id: location.pathname,
  title: '设计模式之观察者模式',
  owner: 'tracholar',
  repo: 'wiki',
  oauth: {
    client_id: '0cc0476e504b5e70ae7c',
    client_secret: 'ab98e39ef79469040057eba9c6b2b543b84c72ee',
  },
  // ...
  // For more available options, check out the documentation below
})

gitment.render('comments')
// or
// gitment.render(document.getElementById('comments'))
// or
// document.body.appendChild(gitment.render())
</script>

        </div>
        <div id="footer">
            <span>
                Copyright © 2018 Norris.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Fork me in <a href="https://github.com/daysneco/wiki" target="_blank"> github </a>.
            </span>
        </div>
        

        <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?df74779713027375e7b79302fb72d7b0";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>


        <script src="/wiki/tipuesearch_content.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch_set.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch.min.js"></script>
    </body>
</html>