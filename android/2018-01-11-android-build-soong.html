<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/normalize.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
        <title>Android编译系统-Android.bp - Norris</title>
        <meta name="keywords" content="technology"/>
        <meta name="description" content="A wiki website of Norris"/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width" />
        
        <script type="text/javascript" 
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>

        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)']]}
            });
        </script>

        <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-78529611-1', 'auto');
          ga('send', 'pageview');

        </script>
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/wiki/">Home</a>&nbsp;»&nbsp;<a href="/wiki/#android">android</a>&nbsp;»&nbsp;Android编译系统-Android.bp</div>
</div>
<div class="clearfix"></div>
<div id="title">Android编译系统-Android.bp</div>
<div id="content">
  <p><a href="https://android.googlesource.com/platform/build/soong/">Soong</a>是替换android中基于make的构建系统，用Android.bp文件替换Android.mk文件，并使用类似于JSON的格式来描述一个模块的构建。</p>
<h2 id="androidbp">Android.bp文件格式</h2>
<p>Android.bp文件设计的非常简单，没有条件判断或者控制流语句，在Go中编写的构建逻辑中处理任何复杂情况。Android.bp文件的语法和语义可能与Bazel BUILD文件类似。</p>
<h2 id="_1">模块</h2>
<p>Android.bp 文件中的模块以一个模块类型开始，后面跟着一组属性，以名值对(<code>name: value</code>)表示。格式为：</p>
<div class="hlcode"><pre><span class="nx">cc_binary</span> <span class="p">{</span>
    <span class="nx">name</span><span class="p">:</span> <span class="s">&quot;gzip&quot;</span><span class="p">,</span>
    <span class="nx">srcs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;src/test/minigzip.c&quot;</span><span class="p">],</span>
    <span class="nx">shared_libs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;libz&quot;</span><span class="p">],</span>
    <span class="nx">stl</span><span class="p">:</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>每个模块必须有一个<code>name</code>属性，并且在所有的Android.bp文件中必须是唯一的。</p>
<p>有效模块类型及其属性的列表，请参阅 <code>$OUT_DIR/soong/.bootstrap/docs/soong_build.html</code></p>
<h2 id="_2">变量</h2>
<p>Android.bp文件可能包含顶级变量并赋值。</p>
<div class="hlcode"><pre><span class="nx">gzip_srcs</span> <span class="p">=</span> <span class="p">[</span><span class="s">&quot;src/test/minigzip.c&quot;</span><span class="p">],</span>

<span class="nx">cc_binary</span> <span class="p">{</span>
    <span class="nx">name</span><span class="p">:</span> <span class="s">&quot;gzip&quot;</span><span class="p">,</span>
    <span class="nx">srcs</span><span class="p">:</span> <span class="nx">gzip_srcs</span><span class="p">,</span>
    <span class="nx">shared_libs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;libz&quot;</span><span class="p">],</span>
    <span class="nx">stl</span><span class="p">:</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>变量的范围被限定为它们声明的文件的剩余部分，以及任何子 blueprint 文件。一个例外是变量不可变，能够被 += 进行附加赋值，而且只能在被引用之前。</p>
<h2 id="_3">注释</h2>
<p>Android.bp文件能包含C风格的多行<code>/* */</code>注释和C++风格的单行注释<code>//</code>。</p>
<h2 id="_4">类型</h2>
<p>变量和属性是强类型的，基于第一个赋值动态变量，以及模块类型静态属性。他们支持的类型有：</p>
<ul>
<li>布尔型（<code>true</code>or<code>false</code>)</li>
<li>整型（<code>int</code>）</li>
<li>字符串（<code>string</code>）</li>
<li>字符串列表（<code>"string1"</code>, <code>"string2"</code>）</li>
<li>Maps (<code>{key1: "value1", key2: ["value2"]}</code>)</li>
</ul>
<p>Map 可以包含任意类型的值，包括嵌套的maps。列表和 maps 允许在最后一个值之后有逗号。</p>
<h2 id="_5">操作符</h2>
<p>字符串、字符串列表、和maps能使用<code>+</code>操作符进行附加。整型可以用<code>+</code>操作符来总结。 附加的maps将生成两个map中键的并集，并附加的两个map中存在任何键的值。</p>
<h2 id="_6">缺省模块</h2>
<p>缺省模块可用于在多个模块中重复相同的属性，例如：</p>
<div class="hlcode"><pre><span class="nx">cc_defaults</span> <span class="p">{</span>
    <span class="nx">name</span><span class="p">:</span> <span class="s">&quot;gzip_defaults&quot;</span><span class="p">,</span>
    <span class="nx">shared_libs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;libz&quot;</span><span class="p">],</span>
    <span class="nx">stl</span><span class="p">:</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">cc_binary</span> <span class="p">{</span>
    <span class="nx">name</span><span class="p">:</span> <span class="s">&quot;gzip&quot;</span><span class="p">,</span>
    <span class="nx">defaults</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;gzip_defaults&quot;</span><span class="p">],</span>
    <span class="nx">srcs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;src/test/minigzip.c&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>


<h2 id="_7">名称解析</h2>
<p>Soong为不同目录中的模块提供了指定相同名称的能力。只要每个模块在一个单独的名称空间中声明。 命名空间可以这样声明：</p>
<div class="hlcode"><pre><span class="nx">soong_namespace</span> <span class="p">{</span>
    <span class="nx">imports</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;path/to/otherNamespace1&quot;</span><span class="p">,</span> <span class="s">&quot;path/to/otherNamespace2&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>


<p>每个Soong模块都会根据其在树中的位置分配一个名称空间，除非找不到soong_namespace模块，否则每个Soong模块都被认为位于当前目录或最接近的父目录中的Android.bp中的soong_namespace所定义的名称空间中。在这种情况下，该模块被认为处于隐式根目录命名空间。</p>
<p>当Soong试图解决声明在我的模块M中命名空间N的依赖关系D时，它导入命名空间I1，I2，I3 ...，那么如果D是形式为<code>“// namespace：module”</code>的完全限定名称，那么只会在指定的名称空间中搜索指定的模块名称。否则，Soong将首先查找声明在名字控制N中的模块名D。如果这个模块不存在，Soong将在名字空间l1，l2，l3...中查找模块名D，最后，Soong将在根名字空间中查找。</p>
<p>在我们完全转换成Make到Soong之前，Make产品配置需要指定一个值PRODUCT_SOONG_NAMESPACES。它的值应该是空格分隔的命名空间列表，用<code>m</code>命令把Soong导出到Make编译。在Make to Soong完全转换之后，启用命名空间的细节可能会发生变化。</p>
<h2 id="_8">格式化</h2>
<p>Soong 包含了一个 blueprint 文件的格式化器，类似于 gofmt。使用以下命令来递归格式化当前目录中的所有 Android.bp 文件：</p>
<div class="hlcode"><pre><span class="nx">bpfmt</span> <span class="o">-</span><span class="nx">w</span> <span class="p">.</span>
</pre></div>


<p>标准格式包括 4 个空格的缩进，包含多个元素的列表中，每个元素之后的换行符，并且始终包括列表和 maps中的逗号。</p>
<h2 id="androidmk">转换Android.mk文件</h2>
<p>Soong包括一个工具执行第一过程转换Android.mk文件到Android.bp文件：</p>
<div class="hlcode"><pre><span class="nx">androidmk</span> <span class="nx">Android</span><span class="p">.</span><span class="nx">mk</span> <span class="p">&gt;</span> <span class="nx">Android</span><span class="p">.</span><span class="nx">bp</span>
</pre></div>


<p>该工具可以转换变量，模块，注释和一些条件，但任何自定义的 Makefile 规则，复杂条件或额外的 include 必须手动转换。</p>
<h2 id="androidmkandroidbp">Android.mk和Android.bp之间的差异</h2>
<ul>
<li>Android.mk文件中经常包含多个模块具有相同的名字（例如，对于同时拥有静态和动态版本的库，或同时供主机和设备使用的库）。Android.pb文件要求每个模块有唯一的名字，但是每个模块能内置多个变化，例如添加<code>host_supported: true</code>。Androidmk转换器将产生多个冲突的模块，必须手动合并到单个模块的<code>target: { android: { }, host: ( )}</code>内。</li>
</ul>
<h2 id="_9">编译逻辑</h2>
<p>编译逻辑是用Go语音的<a href="https://godoc.org/github.com/google/blueprint">blueprint</a>框架写的。编译逻辑接收模块定义，并利用反射和编译规则解析为Go数据结构。构建规则由blueprint收集并写入<a href="https://ninja-build.org/">ninja</a>构建文件。</p>
<h2 id="faq">FAQ</h2>
<h3 id="_10">如何写一个条件？</h3>
<p>Soong故意不支持Android.bp文件中的条件。作为替换，需要条件的复杂的构建规则已被Go语言处理。可以使用高级语言特征来跟踪由条件引入的隐式依赖关系。大多数条件将被转换为map属性，map中的一个值将被选中并附加到顶级属性。</p>
<p>例如，支持特定架构的文件：</p>
<div class="hlcode"><pre><span class="nx">cc_library</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="nx">srcs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;generic.cpp&quot;</span><span class="p">],</span>
    <span class="nx">arch</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">arm</span><span class="p">:</span> <span class="p">{</span>
            <span class="nx">srcs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;arm.cpp&quot;</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="nx">x86</span><span class="p">:</span> <span class="p">{</span>
            <span class="nx">srcs</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;x86.cpp&quot;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>


<p>有关产品变量或环境变量的更复杂条件的示例，请参阅<a href="https://android.googlesource.com/platform/art/+/master/build/art.go">art/build/art.go</a>或者<a href="https://android.googlesource.com/platform/external/llvm/+/master/soong/llvm.go">external/llvm/soong/llvm.go</a>。</p>
</div>
<div id="content-footer">created in <span class="create-date date"> 2018-01-11 15:30 </span></div>
<div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script type="text/javascript">
const gitment = new Gitment({
  id: location.pathname,
  title: 'Android编译系统-Android.bp',
  owner: 'tracholar',
  repo: 'wiki',
  oauth: {
    client_id: '0cc0476e504b5e70ae7c',
    client_secret: 'ab98e39ef79469040057eba9c6b2b543b84c72ee',
  },
  // ...
  // For more available options, check out the documentation below
})

gitment.render('comments')
// or
// gitment.render(document.getElementById('comments'))
// or
// document.body.appendChild(gitment.render())
</script>

        </div>
        <div id="footer">
            <span>
                Copyright © 2018 Norris.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Fork me in <a href="https://github.com/daysneco/wiki" target="_blank"> github </a>.
            </span>
        </div>
        

        <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?df74779713027375e7b79302fb72d7b0";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>


        <script src="/wiki/tipuesearch_content.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch_set.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch.min.js"></script>
    </body>
</html>